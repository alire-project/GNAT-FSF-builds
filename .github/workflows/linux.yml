name: GNAT Linux
on:
  #schedule:
  #  - cron:  '0 0 * * *'
  #push:
  pull_request:


jobs:
  gnat_gprbuild:
    name: GNAT Linux and GPRbuild
    runs-on: ubuntu-18.04
    steps:
    - name: Checkout Project
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.8

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install e3-core
    - name: Install Ada dependencies
      run: sudo apt-get install gnat

    - name: Build GNAT native
      run: ./anod build gcc -v --loglevel DEBUG --enable-cleanup

    - name: Build GDB
      run: ./anod build gdb -v --loglevel DEBUG --enable-cleanup

    - name: Package GNAT
      run: ./anod build release_package --qualifier=package=gnat,do_gh_release -v --loglevel DEBUG
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # for GitHub CLI tool

    - name: Build GPRbuild
      run: ./anod build gprbuild -v --loglevel DEBUG --enable-cleanup

    - name: Package GPRbuild
      run: ./anod build release_package --qualifier=package=gprbuild,do_gh_release -v --loglevel DEBUG
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # for GitHub CLI tool

    - uses: actions/upload-artifact@v2
      with:
        name: anod-artifacts
        path: out_artifacts/*
        retention-days: 1

    - uses: actions/upload-artifact@v2
      with:
        name: release-packages
        path: sbx/*/release_package*/install/*
        retention-days: 5



  gnatcov:
    name: GNATcov
    needs: gnat_gprbuild
    runs-on: ubuntu-18.04
    steps:
    - name: Checkout Project
      uses: actions/checkout@v2

    - uses: actions/download-artifact@v2
      with:
        name: anod-artifacts
        path: in_artifacts/

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.8

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install e3-core
    - name: Build GNATcov
      run: ./anod build gnatcov -v --loglevel DEBUG --enable-cleanup

    - name: Package GNATcov
      run: ./anod build release_package --qualifier=package=gnatcov,do_gh_release -v --loglevel DEBUG
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # for GitHub CLI tool

    - uses: actions/upload-artifact@v2
      with:
        name: release-packages
        path: sbx/*/release_package*/install/*
        retention-days: 5



  gnat_cross:
    strategy:
      matrix:
        target: ["arm-elf", "riscv64-elf", "avr-elf"]
    name: GNAT ${{ matrix.target }}-linux
    needs: gnat_gprbuild
    runs-on: ubuntu-18.04
    steps:
    - name: Checkout Project
      uses: actions/checkout@v2

    - uses: actions/download-artifact@v2
      with:
        name: anod-artifacts
        path: in_artifacts/

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.8

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install e3-core
    - name: Build GNAT ${{ matrix.target }}
      run: ./anod build gcc -v --loglevel DEBUG --target=${{ matrix.target }} --enable-cleanup

    - name: Build GDB ${{ matrix.target }}
      run: ./anod build gdb -v --loglevel DEBUG --target=${{ matrix.target }} --enable-cleanup

    - name: Package GNAT ${{ matrix.target }}
      run: ./anod build release_package --qualifier=package=gnat,do_gh_release --target=${{ matrix.target }} -v --loglevel DEBUG
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # for GitHub CLI tool

    - uses: actions/upload-artifact@v2
      with:
        name: release-packages
        path: sbx/*/release_package*/install/*
        retention-days: 5


  sanity_checking:
    name: Sanity Checking
    needs: [gnat_gprbuild, gnatcov]
    runs-on: ubuntu-18.04
    steps:
    - name: Checkout Project
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.8

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install e3-testsuite

    - uses: actions/download-artifact@v2
      with:
        name: release-packages
        path: ./sanity-checking/release_packages

    - name: Run testsuite
      run: |
          cd ./sanity-checking
          python3 ./run.py -v --install-deps-from=release_packages --pkgs-install-dir=pkgs_install --failure-exit-code 1

    - uses: actions/upload-artifact@v2
      if: failure()
      with:
        name: testsuite-results-${{runner.os}}
        path: sanity-checking/out/new
        retention-days: 5
